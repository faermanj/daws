# aws cloudformation deploy --stack-name resources-bucket-resources --template-file solutions/petoboto-resources/bucket.cform.yaml 
# BUCKET_NAME=$(aws cloudformation describe-stacks --stack-name resources-bucket-resources --query "Stacks[0].Outputs[?OutputKey=='BucketName'].OutputValue" --output text)
# echo $BUCKET_NAME
# aws s3 cp html/simple-html/tuna-bigfile.jpg s3://$BUCKET_NAME/ --acl public-read
# OBJECT_URL="http://$BUCKET_NAME.s3.amazonaws.com/tuna-bigfile.jpg"
# echo $OBJECT_URL
# time curl $OBJECT_URL -o /dev/null
# ab -k -t 333 -c 99 -r $OBJECT_URL
AWSTemplateFormatVersion: 2010-09-09
Description: Simple S3 bucket template.

Parameters:
  EnvId:
    Type: String
    Default: project
    Description: Environment identifier used to prefix exported outputs.
  Color:
    Type: String
    Default: flicts
    Description: Color identifier used to suffix exported outputs for multi-color deployments.

Resources:

  ResourcesBucket:
    Type: AWS::S3::Bucket
    # add static website configuration
    Properties:
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      PublicAccessBlockConfiguration:
        BlockPublicAcls: false
        BlockPublicPolicy: false
        IgnorePublicAcls: false
        RestrictPublicBuckets: false

  ResourcesBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref ResourcesBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowAnyPrincipalReadOnly
            Effect: Allow
            Principal: "*"
            Action:
              - s3:GetObject
            Resource: !Sub "arn:aws:s3:::${ResourcesBucket}/*"

Outputs:
  ResourcesBucketName:
    Description: Resource bucket name.
    Value: !Ref ResourcesBucket
    Export:
      Name: !Sub '${EnvId}-${Color}-ResourcesBucketName'
  WebsiteURL:
    Description: S3 static website endpoint
    Value: !GetAtt ResourcesBucket.WebsiteURL
    Export:
      Name: !Sub '${EnvId}-${Color}-WebsiteURL'